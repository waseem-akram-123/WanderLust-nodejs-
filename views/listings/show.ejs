<% layout("layouts/boilerplate") %>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm mb-5">
        <div class="text-center p-3">
          <img
            src="<%= listing.image?.url || 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=800&q=80' %>"
            alt="<%= listing.title %>"
            class="img-fluid rounded-3"
            style="max-height: 400px; width: 85%; object-fit: cover"
          />
        </div>

        <div class="card-body p-4">
          <h1 class="fw-bold mb-2"><%= listing.title %></h1>
          <div class="d-flex align-items-center gap-2 mb-3">
            <i class="bi bi-geo-alt-fill text-primary"></i>
            <h5 class="mb-0 fw-semibold">
              <%= listing.location %>, <%= listing.country %>
            </h5>
          </div>

          <div class="bg-light p-3 rounded mb-4">
            <h4 class="text-success mb-0">
              &#8377; <%= Number(listing.price).toLocaleString("en-IN") %>
              <span class="text-muted fs-6 fw-normal">per night</span>
            </h4>
          </div>

          <div class="mb-4">
            <h5 class="fw-semibold mb-3">Description</h5>
            <p class="mb-0" style="line-height: 1.7">
              <%= listing.description %>
            </p>
          </div>

          <div
            class="d-flex align-items-center gap-3 mb-4 p-3 bg-light rounded"
          >
            <div class="bg-white rounded-circle p-2 shadow-sm">
              <i class="bi bi-person-circle fs-3 text-muted"></i>
            </div>
            <div>
              <p class="mb-0 text-muted">Hosted by</p>
              <p class="mb-0 fw-semibold">
                <%= listing.author?.username || "Unknown" %>
              </p>
            </div>
          </div>

          <% if (currentUser && currentUser._id.toString() ===
          listing.author?._id.toString()) { %>
          <div class="d-flex gap-3 mb-4">
            <a
              href="/listings/<%= listing._id %>/edit"
              class="btn btn-primary px-4"
            >
              <i class="bi bi-pencil-square me-2"></i>Edit Listing
            </a>
            <form
              method="POST"
              action="/listings/<%= listing._id %>?_method=DELETE"
              onsubmit="return confirm('Are you sure you want to delete this listing?');"
            >
              <button type="submit" class="btn btn-outline-danger px-4">
                <i class="bi bi-trash3 me-2"></i>Delete
              </button>
            </form>
          </div>
          <% } %>

          <div class="mb-5">
            <h5 class="fw-semibold mb-3">Location</h5>
            <div
              id="map"
              class="rounded-3"
              style="height: 300px; background-color: #f5f5f5"
            ></div>
          </div>

          <div class="border-top pt-4">
            <h4 class="fw-semibold mb-4">
              <i class="bi bi-star-fill text-warning me-2"></i>
              Reviews <% if (listing.reviews.length > 0) { %>
              <span class="badge bg-primary ms-2"
                ><%= listing.reviews.length %></span
              >
              <% } %>
            </h4>

            <div class="card border-0 shadow-sm mb-5">
              <div class="card-body p-4">
                <h5 class="card-title mb-4">Share your experience</h5>
                <form
                  id="reviewForm"
                  action="/listings/<%= listing._id %>/reviews"
                  method="POST"
                  class="needs-validation"
                  novalidate
                >
                  <!-- Rating Slider -->
                  <div class="mb-4">
                    <label for="ratingRange" class="form-label fw-semibold"
                      >Rating</label
                    >
                    <input
                      type="range"
                      class="form-range"
                      id="ratingRange"
                      name="review[rating]"
                      min="1"
                      max="5"
                      value="3"
                      step="1"
                      required
                    />
                    <div class="mt-2 fw-bold" id="ratingText">3 stars</div>
                  </div>

                  <div class="mb-4">
                    <label for="comment" class="form-label fw-semibold"
                      >Your review</label
                    >
                    <textarea
                      name="review[comment]"
                      id="comment"
                      class="form-control"
                      rows="4"
                      placeholder="Share details of your experience..."
                      required
                    ></textarea>
                    <div class="invalid-feedback">Please add some comment.</div>
                    <div class="valid-feedback">Comment looks good!</div>
                  </div>

                  <button type="submit" class="btn btn-primary px-4">
                    <i class="bi bi-send-fill me-2"></i>Submit Review
                  </button>
                </form>
              </div>
            </div>

            <% if (listing.reviews.length === 0) { %>
            <div class="text-center py-5 bg-light rounded-3">
              <i class="bi bi-chat-square-text fs-1 text-muted mb-3"></i>
              <h5 class="fw-semibold">No reviews yet</h5>
              <p class="text-muted">Be the first to share your experience!</p>
            </div>
            <% } else { %>
            <div class="row g-3">
              <% for (let review of listing.reviews) { %>
              <div class="col-12">
                <div class="card border-0 shadow-sm mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                      <div class="d-flex align-items-center gap-3">
                        <div
                          class="bg-primary bg-opacity-10 text-primary rounded-circle p-2"
                        >
                          <i class="bi bi-person-fill"></i>
                        </div>
                        <div>
                          <h6 class="mb-0 fw-semibold">
                            <%= review.author?.username || "Anonymous" %>
                          </h6>
                          <small class="text-muted">
                            <%= new
                            Date(review.createdAt).toLocaleDateString('en-US', {
                            year: 'numeric', month: 'long', day: 'numeric' }) %>
                          </small>
                        </div>
                      </div>
                      <div class="text-warning">
                        <% for (let i = 1; i <= 5; i++) { %>
                        <i
                          class="bi bi-star<%= i <= review.rating ? '-fill' : '' %>"
                        ></i>
                        <% } %>
                      </div>
                    </div>
                    <p class="mb-0 mt-2"><%= review.comment %></p>
                  </div>
                  <% if (currentUser && currentUser._id.toString() ===
                  review.author?._id.toString()) { %>
                  <div class="card-footer bg-transparent border-0 pt-0">
                    <form
                      method="POST"
                      action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                      onsubmit="return confirm('Delete your review?');"
                    >
                      <button class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash3 me-1"></i>Delete
                      </button>
                    </form>
                  </div>
                  <% } %>
                </div>
              </div>
              <% } %>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script id="listing-data" type="application/json">
  <%- JSON.stringify({
    coordinates: listing.geometry.coordinates || [],
    title: listing.title,
    location: listing.location
  }) %>
</script>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
/>

<style>
  /* Map Container */
  #map {
    border: 1px solid #eee;
    border-radius: 8px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const listingData = JSON.parse(
      document.getElementById("listing-data").textContent
    );
    if (listingData.coordinates.length === 2) {
      const map = L.map("map").setView(listingData.coordinates, 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      const customIcon = L.divIcon({
        html: '<i class="bi bi-geo-alt-fill text-danger fs-4"></i>',
        iconSize: [24, 24],
        className: "bg-transparent",
      });

      L.marker(listingData.coordinates, { icon: customIcon })
        .addTo(map)
        .bindPopup(`<b>${listingData.title}</b><br>${listingData.location}`)
        .openPopup();
    }

    // Rating Slider JS
    const ratingRange = document.getElementById("ratingRange");
    const ratingText = document.getElementById("ratingText");

    function updateRatingText(value) {
      ratingText.textContent = value + (value === "1" ? " star" : " stars");
    }

    updateRatingText(ratingRange.value);

    ratingRange.addEventListener("input", (e) => {
      updateRatingText(e.target.value);
    });
  });
</script>
